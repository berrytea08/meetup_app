<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetUp！</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        .pac-container { z-index: 9999 !important; }
        #map.crosshair-cursor { cursor: crosshair !important; }
        .scroll-smooth { scroll-behavior: smooth; }
        #results-container, #main-content { scroll-margin-top: 60px; }
        .group:focus-within .group-focus\:rotate-180 { transform: rotate(180deg); }
        details[open] > summary .group-open\:rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto md:p-4">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-900">
                        <i class="fas fa-users text-blue-500"></i> MeetUp!
                    </h1>
                    <button id="toggle-sidebar-btn" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex flex-col md:flex-row">
            <!-- Sidebar / Settings Panel -->
            <aside id="sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-white p-6 shadow-lg md:rounded-lg md:m-2 transition-transform transform -translate-x-full md:translate-x-0 fixed md:static h-full overflow-y-auto top-0 left-0 z-50 md:z-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">⚙️ 設定</h2>
                    <button id="close-sidebar-btn" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 hover:bg-gray-100">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label for="api_key_maps" class="block text-sm font-medium text-gray-700">Google Maps APIキー</label>
                        <input type="password" id="api_key_maps" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <button id="map-input-btn" class="w-full flex items-center justify-center px-4 py-2 border border-dashed border-gray-400 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-map-marked-alt mr-2"></i>地図から出発地を指定
                        </button>
                    </div>

                    <div id="participants-container" class="space-y-4">
                        <h3 class="text-lg font-semibold border-b pb-2">メンバー</h3>
                    </div>
                    <div class="flex space-x-2">
                        <button id="add-participant-btn" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-plus mr-2"></i>追加
                        </button>
                        <button id="remove-participant-btn" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-minus mr-2"></i>削除
                        </button>
                    </div>

                    <div>
                        <label for="destination_address" class="block text-sm font-medium text-gray-700">🏁 最終目的地 (任意)</label>
                        <input type="text" id="destination_address" placeholder="例: 東京タワー" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <details class="group">
                        <summary class="flex items-center justify-between w-full p-2 font-medium text-left text-gray-700 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 focus:outline-none">
                            <span>詳細な検索オプション</span>
                            <i class="fas fa-chevron-down group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="p-4 mt-2 space-y-4 border rounded-lg">
                             <div>
                                <label for="common_mode" class="block text-sm font-medium text-gray-700">集合場所→目的地 の移動手段</label>
                                <select id="common_mode" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="DRIVING">自動車</option>
                                    <option value="TRANSIT">公共交通機関</option>
                                    <option value="WALKING">徒歩</option>
                                    <option value="BICYCLING">自転車</option>
                                </select>
                            </div>
                            <div>
                                <label for="search_algorithm" class="block text-sm font-medium text-gray-700">検索アルゴリズム</label>
                                <select id="search_algorithm" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="fairness">公平性重視 (移動時間のバラつき最小)</option>
                                    <option value="efficiency">効率性重視 (合計移動時間最小)</option>
                                    <option value="max_relief">最大負担軽減 (最大移動時間最小)</option>
                                    <option value="quality">場所の質を重視 (評価＋公平性)</option>
                                </select>
                            </div>
                            <div>
                                <label for="place_types" class="block text-sm font-medium text-gray-700">集合場所の種類</label>
                                <select id="place_types" multiple class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md h-32">
                                    <option value="cafe" selected>カフェ</option>
                                    <option value="restaurant" selected>レストラン</option>
                                    <option value="park">公園</option>
                                    <option value="train_station">駅</option>
                                    <option value="book_store">書店</option>
                                    <option value="shopping_mall">ショッピングモール</option>
                                </select>
                            </div>
                            <div>
                                <label for="search_radius" class="block text-sm font-medium text-gray-700">検索半径: <span id="radius_value">5000</span>m</label>
                                <input type="range" id="search_radius" min="1000" max="10000" value="5000" step="500" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                             <div>
                                <label for="departure_time" class="block text-sm font-medium text-gray-700">出発/到着 時刻</label>
                                <input type="datetime-local" id="departure_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <select id="time_type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="departure">この時刻に出発</option>
                                    <option value="arrival">この時刻に到着 (公共交通機関のみ)</option>
                                </select>
                            </div>
                            <div class="relative flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="avoid_tolls" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="avoid_tolls" class="font-medium text-gray-700">有料道路を避ける (自動車)</label>
                                </div>
                            </div>
                        </div>
                    </details>

                    <button id="search-btn" class="w-full flex items-center justify-center px-6 py-3 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-rocket mr-3"></i>検索開始
                    </button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="w-full md:w-2/3 lg:w-3/4 p-2 md:p-6" id="main-content">
                <div id="info-panel" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6" role="alert">
                    <p class="font-bold">ようこそ！</p>
                    <p>左のパネルからAPIキーとメンバー情報を設定し、「検索開始」ボタンを押してください。</p>
                     <div id="map-input-info" class="hidden mt-2 p-2 bg-blue-200 rounded">
                        <i class="fas fa-info-circle mr-1"></i> 地図上の地点をクリックして、出発地または目的地に設定できます。
                    </div>
                </div>

                <div id="map-container" class="w-full h-96 md:h-[500px] bg-gray-200 rounded-lg shadow-md mb-6 relative">
                     <div id="map" class="w-full h-full rounded-lg"></div>
                     <div id="map-loader" class="hidden absolute inset-0 bg-white/70 flex items-center justify-center flex-col space-y-2 z-20">
                        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
                        <p class="text-lg font-medium">地図を初期化中...</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="hidden scroll-smooth">
                    <div id="status-container" class="my-4 text-center p-4 border rounded-lg bg-gray-50 hidden">
                        <div id="status-text" class="text-lg font-semibold text-gray-800"></div>
                        <div id="sub-status-text" class="text-sm text-gray-600 mt-1 h-5"></div>
                         <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                            <div id="progress-bar-inner" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="candidates-list" class="space-y-6">
                        <!-- Candidate cards will be shown here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Map Input Modal -->
    <div id="map-input-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">地点の設定</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-4" id="modal-address"></p>
                    <p class="text-sm text-gray-600">この地点をどこに設定しますか？</p>
                    <select id="modal-target-select" class="mt-2 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
                        設定する
                    </button>
                    <button id="modal-cancel-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        キャンセル
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State & DOM Elements ---
        let map, geocoder, directionsService, directionsRenderer;
        let autocompleteObjects = [];
        let participantCount = 0;
        let isMapInputMode = false;
        let clickedLocation = null;
        let currentMarkers = [];
        let currentPolylines = [];

        const DOM = {
            apiKeyMaps: document.getElementById('api_key_maps'),
            participantsContainer: document.getElementById('participants-container'),
            addBtn: document.getElementById('add-participant-btn'),
            removeBtn: document.getElementById('remove-participant-btn'),
            searchBtn: document.getElementById('search-btn'),
            mapContainer: document.getElementById('map'),
            mapLoader: document.getElementById('map-loader'),
            infoPanel: document.getElementById('info-panel'),
            resultsContainer: document.getElementById('results-container'),
            candidatesList: document.getElementById('candidates-list'),
            statusContainer: document.getElementById('status-container'),
            statusText: document.getElementById('status-text'),
            subStatusText: document.getElementById('sub-status-text'),
            progressBar: document.getElementById('progress-bar'),
            progressBarInner: document.getElementById('progress-bar-inner'),
            destinationAddress: document.getElementById('destination_address'),
            toggleSidebarBtn: document.getElementById('toggle-sidebar-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            sidebar: document.getElementById('sidebar'),
            mapInputBtn: document.getElementById('map-input-btn'),
            mapInputInfo: document.getElementById('map-input-info'),
            mapInputModal: document.getElementById('map-input-modal'),
            modalAddress: document.getElementById('modal-address'),
            modalTargetSelect: document.getElementById('modal-target-select'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
        };
        
        // --- Initialization ---
        window.onload = () => {
            setupEventListeners();
            addParticipant(); // Add first participant
            addParticipant(); // Add second participant
        };

        function initializeGoogleMaps() {
            const apiKey = DOM.apiKeyMaps.value;
            if (!apiKey) {
                DOM.mapLoader.classList.remove('hidden');
                DOM.mapLoader.innerHTML = `<i class="fas fa-key fa-3x text-red-500"></i><p class="text-lg font-medium mt-2">Maps APIキーを入力してください</p>`;
                return;
            }
            if (window.google?.maps) return;

            DOM.mapLoader.classList.remove('hidden');
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,routes&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                DOM.mapLoader.innerHTML = `<i class="fas fa-exclamation-triangle fa-3x text-red-500"></i><p class="text-lg font-medium mt-2">APIキーが無効か、読み込みに失敗しました。</p>`;
                alert("Google Mapsの読み込みに失敗しました。APIキーを確認してください。");
            };
            window.initMap = initMap; // Make it globally accessible for the callback
            document.head.appendChild(script);
        }

        function initMap() {
            DOM.mapLoader.classList.add('hidden');
            const tokyoStation = { lat: 35.681236, lng: 139.767125 };
            map = new google.maps.Map(DOM.mapContainer, {
                center: tokyoStation,
                zoom: 12,
                mapTypeControl: false,
                streetViewControl: false,
            });
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });
            
            map.addListener('click', handleMapClick);

            document.querySelectorAll('input[data-participant-address]').forEach(input => {
                setupAutocomplete(input);
            });
            setupAutocomplete(DOM.destinationAddress);
        }
        
        // --- UI & Event Listeners ---
        function setupEventListeners() {
            DOM.apiKeyMaps.addEventListener('change', initializeGoogleMaps);
            DOM.addBtn.addEventListener('click', addParticipant);
            DOM.removeBtn.addEventListener('click', removeParticipant);
            DOM.searchBtn.addEventListener('click', startSearch);
            DOM.toggleSidebarBtn.addEventListener('click', () => DOM.sidebar.classList.remove('-translate-x-full'));
            DOM.closeSidebarBtn.addEventListener('click', () => DOM.sidebar.classList.add('-translate-x-full'));
            DOM.mapInputBtn.addEventListener('click', toggleMapInputMode);
            DOM.modalConfirmBtn.addEventListener('click', confirmMapLocation);
            DOM.modalCancelBtn.addEventListener('click', () => DOM.mapInputModal.classList.add('hidden'));
            
            const radiusSlider = document.getElementById('search_radius');
            if (radiusSlider) {
                radiusSlider.addEventListener('input', (e) => {
                    document.getElementById('radius_value').textContent = e.target.value;
                });
            }
        }

        function addParticipant() {
            participantCount++;
            const id = participantCount;
            const participantHTML = `
                <div id="participant-${id}" class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <label class="block text-sm font-medium text-gray-700">メンバー ${id}</label>
                    <div class="mt-2 space-y-2">
                        <input type="text" id="name-${id}" value="メンバー ${id}" placeholder="名前" class="w-full text-sm p-2 border rounded-md">
                        <div class="relative">
                            <input type="text" id="address-${id}" data-participant-address="${id}" placeholder="出発地の住所" class="w-full text-sm p-2 border rounded-md pr-10">
                            <button class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-600" title="GPSで現在地を取得" onclick="getCurrentLocation(${id})">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                        </div>
                        <select id="mode-${id}" class="w-full text-sm p-2 border rounded-md">
                            <option value="DRIVING">自動車</option>
                            <option value="TRANSIT">公共交通機関</option>
                            <option value="WALKING">徒歩</option>
                            <option value="BICYCLING">自転車</option>
                        </select>
                    </div>
                </div>`;
            DOM.participantsContainer.insertAdjacentHTML('beforeend', participantHTML);
            
            if (window.google?.maps) {
                setupAutocomplete(document.getElementById(`address-${id}`));
            }
        }
        
        function removeParticipant() {
            if (participantCount > 1) {
                document.getElementById(`participant-${participantCount}`)?.remove();
                participantCount--;
            }
        }
        
        function setupAutocomplete(inputElement) {
            const autocomplete = new google.maps.places.Autocomplete(inputElement, {
                types: ['address'],
                componentRestrictions: { country: 'jp' }
            });
            autocompleteObjects.push(autocomplete);
        }

        window.getCurrentLocation = function(id) {
            if (!navigator.geolocation) {
                alert("お使いのブラウザはGPS機能に対応していません。");
                return;
            }
            navigator.geolocation.getCurrentPosition(position => {
                const latLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                geocoder.geocode({ location: latLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        document.getElementById(`address-${id}`).value = results[0].formatted_address;
                    } else { alert("住所の取得に失敗しました。"); }
                });
            }, () => alert("GPS情報の取得に失敗しました。位置情報へのアクセスを許可してください。"));
        }
        
        // --- Map Input Logic ---
        function toggleMapInputMode() {
            isMapInputMode = !isMapInputMode;
            DOM.mapContainer.classList.toggle('crosshair-cursor', isMapInputMode);
            DOM.mapInputInfo.classList.toggle('hidden', !isMapInputMode);
            DOM.mapInputBtn.classList.toggle('bg-blue-100', isMapInputMode);
            DOM.mapInputBtn.classList.toggle('border-blue-500', isMapInputMode);
            DOM.mapInputBtn.innerHTML = isMapInputMode 
                ? '<i class="fas fa-times mr-2"></i>地図からの指定をキャンセル'
                : '<i class="fas fa-map-marked-alt mr-2"></i>地図から出発地を指定';
        }
        
        function handleMapClick(event) {
            if (!isMapInputMode) return;
            clickedLocation = event.latLng;
            geocoder.geocode({ location: clickedLocation }, (results, status) => {
                if (status === "OK" && results[0]) {
                    DOM.modalAddress.textContent = `地点: ${results[0].formatted_address}`;
                    populateModalSelect();
                    DOM.mapInputModal.classList.remove('hidden');
                } else {
                    alert("この地点の情報を取得できませんでした。");
                }
            });
        }
        
        function populateModalSelect() {
            let options = `<option value="destination">🏁 最終目的地</option>`;
            for (let i = 1; i <= participantCount; i++) {
                const name = document.getElementById(`name-${i}`).value;
                options += `<option value="participant-${i}">メンバー ${i} (${name})</option>`;
            }
            DOM.modalTargetSelect.innerHTML = options;
        }
        
        function confirmMapLocation() {
            const target = DOM.modalTargetSelect.value;
            const address = DOM.modalAddress.textContent.replace('地点: ', '');
            if (target === 'destination') {
                DOM.destinationAddress.value = address;
            } else {
                const id = target.split('-')[1];
                document.getElementById(`address-${id}`).value = address;
            }
            DOM.mapInputModal.classList.add('hidden');
            toggleMapInputMode(); // Exit map input mode
        }

        // --- Core Search Logic ---
        async function startSearch() {
            DOM.infoPanel.classList.add('hidden');
            DOM.resultsContainer.classList.remove('hidden');
            DOM.candidatesList.innerHTML = '';
            DOM.statusContainer.classList.remove('hidden');
            document.getElementById('main-content').scrollIntoView({ behavior: 'smooth' });

            try {
                const settings = getSettings();
                if (!settings) return;

                updateStatus("STEP 1/4: 出発地の座標を調べています...", 0);
                const geocodedOrigins = await geocodeParticipants(settings.participants);

                let geocodedDestination = null;
                if (settings.destinationAddress) {
                    geocodedDestination = await geocodeAddress(settings.destinationAddress);
                }
                
                updateStatus("STEP 2/4: 周辺の集合場所候補を探しています...", 25);
                const center = calculateCenter(geocodedOrigins, geocodedDestination);
                const candidatePlaces = await findNearbyPlaces(center, settings.searchRadius, settings.placeTypes);
                if (candidatePlaces.length === 0) {
                     throw new Error("条件に合う施設が見つかりませんでした。検索半径や場所の種類を変更してください。");
                }

                updateStatus("STEP 3/4: 各候補地への移動時間を計算しています...", 50, "準備中...");
                const evaluatedCandidates = await evaluateCandidates(candidatePlaces, geocodedOrigins, geocodedDestination, settings);
                if (evaluatedCandidates.length === 0) {
                     throw new Error("評価可能な集合場所が見つかりませんでした。移動できない場所が含まれている可能性があります。");
                }
                
                updateStatus("STEP 4/4: 結果をまとめています...", 90);
                const sortedCandidates = sortCandidates(evaluatedCandidates, settings.searchAlgorithm);
                const topCandidates = sortedCandidates.slice(0, 5); // Show top 5
                
                updateStatus("検索完了！", 100);
                displayResults(topCandidates, geocodedOrigins, geocodedDestination);
                setTimeout(() => DOM.statusContainer.classList.add('hidden'), 4000);

            } catch (error) {
                console.error("検索エラー:", error);
                updateStatus(`エラー: ${error.message}`, -1);
            }
        }
        
        function getSettings() {
            const participants = [];
            for (let i = 1; i <= participantCount; i++) {
                const addressInput = document.getElementById(`address-${i}`);
                if (!addressInput.value.trim()) { alert(`メンバー ${i} の住所を入力してください。`); return null; }
                participants.push({
                    id: i,
                    name: document.getElementById(`name-${i}`).value,
                    address: addressInput.value,
                    mode: document.getElementById(`mode-${i}`).value
                });
            }
            if (participants.length < 2) { alert("メンバーは2人以上必要です。"); return null; }
            
            const drivingOptions = {};
            const transitOptions = {};
            const departureTime = document.getElementById('departure_time').value;
            if (departureTime) {
                const time = new Date(departureTime);
                if(document.getElementById('time_type').value === 'departure') {
                    drivingOptions.departureTime = time;
                    transitOptions.departureTime = time;
                } else {
                    transitOptions.arrivalTime = time; // Arrival time is only for transit
                }
            }

            return {
                participants,
                destinationAddress: document.getElementById('destination_address').value.trim(),
                commonMode: document.getElementById('common_mode').value,
                searchAlgorithm: document.getElementById('search_algorithm').value,
                placeTypes: Array.from(document.getElementById('place_types').selectedOptions).map(opt => opt.value),
                searchRadius: parseInt(document.getElementById('search_radius').value, 10),
                avoidTolls: document.getElementById('avoid_tolls').checked,
                drivingOptions,
                transitOptions
            };
        }

        async function evaluateCandidates(candidates, origins, destination, settings) {
            let evaluated = [];
            for (let i = 0; i < candidates.length; i++) {
                const place = candidates[i];
                updateStatus("STEP 3/4: 各候補地への移動時間を計算しています...", 50 + (40 * (i/candidates.length)), `評価中 [${i+1}/${candidates.length}]: ${place.name}`);

                let t2_duration_sec = 0;
                if (destination) {
                    const dirToDest = await getDirections(place.geometry.location, destination.geometry.location, settings.commonMode, settings);
                    if (!dirToDest) continue; // Skip if candidate is unreachable from destination
                    t2_duration_sec = dirToDest.routes[0].legs[0].duration.value;
                }

                const durations = [];
                let isReachableByAll = true;
                for (const origin of origins) {
                    const dirToPlace = await getDirections(origin.location, place.geometry.location, origin.mode, settings);
                    if (dirToPlace) {
                        const t1_duration = dirToPlace.routes[0].legs[0].duration;
                        const total_sec = t1_duration.value + t2_duration_sec;
                        durations.push({ 
                            origin_name: origin.name, 
                            total_sec, 
                            total_text: secondsToText(total_sec),
                        });
                    } else {
                        isReachableByAll = false;
                        break;
                    }
                }
                
                if (isReachableByAll) {
                    const times = durations.map(d => d.total_sec);
                    evaluated.push({
                        place,
                        durations,
                        stats: {
                            std_dev: calculateStdDev(times),
                            total: times.reduce((a, b) => a + b, 0),
                            max: Math.max(...times),
                            rating: place.rating || 0
                        }
                    });
                }
            }
            return evaluated;
        }

        // --- Utility & Helper Functions (Geocoding, API calls, etc.) ---
        
        async function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address }, (results, status) => {
                    if (status === 'OK') resolve(results[0]);
                    else reject(new Error(`「${address}」の座標取得に失敗: ${status}`));
                });
            });
        }
        
        async function geocodeParticipants(participants) {
            const geocoded = [];
            for (const p of participants) {
                const result = await geocodeAddress(p.address);
                geocoded.push({ ...p, location: result.geometry.location, formatted_address: result.formatted_address });
            }
            return geocoded;
        }

        function calculateCenter(origins, destination) {
            const points = origins.map(o => o.location);
            if (destination) points.push(destination.geometry.location);
            const lat = points.reduce((sum, p) => sum + p.lat(), 0) / points.length;
            const lng = points.reduce((sum, p) => sum + p.lng(), 0) / points.length;
            return { lat, lng };
        }

        async function findNearbyPlaces(center, radius, types) {
             return new Promise((resolve) => {
                const service = new google.maps.places.PlacesService(map);
                const request = { location: center, radius, types, language: 'ja' };
                service.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK || status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                        resolve(results || []);
                    } else {
                         console.warn("Nearby search failed:", status);
                         resolve([]);
                    }
                });
            });
        }
        
        async function getDirections(origin, destination, mode, settings) {
            const request = {
                origin,
                destination,
                travelMode: google.maps.TravelMode[mode],
                avoidTolls: settings.avoidTolls,
            };
            if (mode === 'DRIVING') {
                Object.assign(request, settings.drivingOptions);
            } else if (mode === 'TRANSIT') {
                Object.assign(request, settings.transitOptions);
            }

            return new Promise(resolve => {
                directionsService.route(request, (result, status) => {
                    if (status === 'OK') resolve(result);
                    else {
                        // console.warn(`Directions failed: ${status} for mode ${mode}`);
                        resolve(null);
                    }
                });
            });
        }
        
        // --- Sorting and Display ---
        
        function sortCandidates(candidates, algorithm) {
            return candidates.sort((a, b) => {
                switch(algorithm) {
                    case 'efficiency': return a.stats.total - b.stats.total;
                    case 'max_relief': return a.stats.max - b.stats.max;
                    case 'quality':
                        const scoreA = (a.stats.std_dev / 300) - (a.stats.rating * 2); 
                        const scoreB = (b.stats.std_dev / 300) - (b.stats.rating * 2);
                        return scoreA - scoreB;
                    default: return a.stats.std_dev - b.stats.std_dev;
                }
            });
        }

        function displayResults(candidates, origins, destination) {
            DOM.candidatesList.innerHTML = '';
            if (candidates.length === 0) {
                DOM.candidatesList.innerHTML = `<p class="text-center text-gray-500">条件に合う候補が見つかりませんでした。</p>`;
                return;
            }
            
            candidates.forEach((candidate, index) => {
                const card = createCandidateCard(candidate, index, origins, destination);
                DOM.candidatesList.appendChild(card);
            });
            
            document.getElementById('candidate-0')?.dispatchEvent(new Event('click'));
        }

        function createCandidateCard(candidate, index, origins, destination) {
            const { place, durations, stats } = candidate;
            const card = document.createElement('div');
            card.id = `candidate-${index}`;
            card.className = 'border rounded-lg p-4 cursor-pointer hover:shadow-lg hover:border-blue-500 transition-all bg-white';
            const ratingHTML = place.rating ? `<span class="text-yellow-500">${'★'.repeat(Math.round(place.rating))}</span> ${place.rating} (${place.user_ratings_total || 'N/A'})` : '評価なし';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xl font-bold text-blue-700">${index + 1}. ${place.name}</h3>
                        <p class="text-sm text-gray-600">${place.vicinity}</p>
                        <p class="text-sm mt-1">${ratingHTML}</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p>公平性 (ばらつき): <strong>${secondsToText(stats.std_dev)}</strong></p>
                        <p>合計時間: <strong>${secondsToText(stats.total, true)}</strong></p>
                        <p>最大時間: <strong>${secondsToText(stats.max)}</strong></p>
                    </div>
                </div>
                <div class="details mt-2 pt-2 border-t hidden">
                    <h4 class="font-semibold">各メンバーの移動時間:</h4>
                    <ul class="list-disc list-inside text-sm mt-1">${durations.map(d => `<li><strong>${d.origin_name}:</strong> ${d.total_text}</li>`).join('')}</ul>
                </div>`;
            
            card.addEventListener('click', () => {
                document.querySelectorAll('.details').forEach(d => d.classList.add('hidden'));
                document.querySelectorAll('.border-blue-500').forEach(el => el.classList.remove('border-blue-500', 'bg-blue-50'));
                card.querySelector('.details').classList.remove('hidden');
                card.classList.add('border-blue-500', 'bg-blue-50');
                updateMapForCandidate(candidate, origins, destination);
            });

            return card;
        }
        
        function updateMapForCandidate(candidate, origins, destination) {
            currentMarkers.forEach(m => m.setMap(null));
            currentPolylines.forEach(p => p.setMap(null));
            currentMarkers = [];
            currentPolylines = [];
            directionsRenderer.setDirections({routes: []}); // Clear previous routes

            const bounds = new google.maps.LatLngBounds();
            const colors = ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#9C27B0', '#FF6D00'];

            origins.forEach((origin, i) => {
                const marker = new google.maps.Marker({
                    position: origin.location,
                    map,
                    label: { text: `${i + 1}`, color: "white" },
                    title: `出発地: ${origin.name}`
                });
                currentMarkers.push(marker);
                bounds.extend(origin.location);
            });

            if (destination) {
                currentMarkers.push(new google.maps.Marker({
                    position: destination.geometry.location,
                    map,
                    icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    title: `最終目的地: ${destination.formatted_address}`
                }));
                 bounds.extend(destination.geometry.location);
            }

            currentMarkers.push(new google.maps.Marker({
                position: candidate.place.geometry.location,
                map,
                icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                title: `集合場所: ${candidate.place.name}`,
                animation: google.maps.Animation.DROP
            }));
            bounds.extend(candidate.place.geometry.location);
            
            map.fitBounds(bounds);
        }

        function updateStatus(message, progress, subMessage = '&nbsp;') {
            DOM.statusText.textContent = message;
            DOM.subStatusText.innerHTML = subMessage;
            DOM.progressBarInner.classList.remove('bg-red-500');
            if (progress >= 0) {
                 DOM.progressBarInner.style.width = `${progress}%`;
                 DOM.statusText.classList.remove('text-red-500');
            } else {
                 DOM.progressBarInner.style.width = `100%`;
                 DOM.progressBarInner.classList.add('bg-red-500');
                 DOM.statusText.classList.add('text-red-500');
            }
        }
        
        function secondsToText(seconds, isTotal = false) {
            seconds = Math.round(seconds);
            const days = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            let text = "";
            if (days > 0 && isTotal) text += `${days}日と`;
            if (h > 0) text += `${h}時間`;
            if (m > 0 || text === "") text += `${m}分`;
            return text.trim() || "0分";
        }

        function calculateStdDev(arr) {
            const n = arr.length;
            if (n < 2) return 0;
            const mean = arr.reduce((a, b) => a + b, 0) / n;
            return Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n);
        }

    </script>
</body>
</html>
