<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetUpï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        .pac-container { z-index: 9999 !important; }
        #map.crosshair-cursor { cursor: crosshair !important; }
        .scroll-smooth { scroll-behavior: smooth; }
        #results-container, #main-content { scroll-margin-top: 60px; }
        .group:focus-within .group-focus\:rotate-180 { transform: rotate(180deg); }
        details[open] > summary .group-open\:rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto md:p-4">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-900">
                        <i class="fas fa-users text-blue-500"></i> MeetUp!
                    </h1>
                    <button id="toggle-sidebar-btn" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex flex-col md:flex-row">
            <!-- Sidebar / Settings Panel -->
            <aside id="sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-white p-6 shadow-lg md:rounded-lg md:m-2 transition-transform transform -translate-x-full md:translate-x-0 fixed md:static h-full overflow-y-auto top-0 left-0 z-50 md:z-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">âš™ï¸ è¨­å®š</h2>
                    <button id="close-sidebar-btn" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-800 hover:bg-gray-100">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label for="api_key_maps" class="block text-sm font-medium text-gray-700">Google Maps APIã‚­ãƒ¼</label>
                        <input type="password" id="api_key_maps" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <button id="map-input-btn" class="w-full flex items-center justify-center px-4 py-2 border border-dashed border-gray-400 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-map-marked-alt mr-2"></i>åœ°å›³ã‹ã‚‰å‡ºç™ºåœ°ã‚’æŒ‡å®š
                        </button>
                    </div>

                    <div id="participants-container" class="space-y-4">
                        <h3 class="text-lg font-semibold border-b pb-2">ãƒ¡ãƒ³ãƒãƒ¼</h3>
                    </div>
                    <div class="flex space-x-2">
                        <button id="add-participant-btn" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-plus mr-2"></i>è¿½åŠ 
                        </button>
                        <button id="remove-participant-btn" class="w-full flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-minus mr-2"></i>å‰Šé™¤
                        </button>
                    </div>

                    <div>
                        <label for="destination_address" class="block text-sm font-medium text-gray-700">ğŸ æœ€çµ‚ç›®çš„åœ° (ä»»æ„)</label>
                        <input type="text" id="destination_address" placeholder="ä¾‹: æ±äº¬ã‚¿ãƒ¯ãƒ¼" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <details class="group">
                        <summary class="flex items-center justify-between w-full p-2 font-medium text-left text-gray-700 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200 focus:outline-none">
                            <span>è©³ç´°ãªæ¤œç´¢ã‚ªãƒ—ã‚·ãƒ§ãƒ³</span>
                            <i class="fas fa-chevron-down group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="p-4 mt-2 space-y-4 border rounded-lg">
                             <div>
                                <label for="common_mode" class="block text-sm font-medium text-gray-700">é›†åˆå ´æ‰€â†’ç›®çš„åœ° ã®ç§»å‹•æ‰‹æ®µ</label>
                                <select id="common_mode" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="DRIVING">è‡ªå‹•è»Š</option>
                                    <option value="TRANSIT">å…¬å…±äº¤é€šæ©Ÿé–¢</option>
                                    <option value="WALKING">å¾’æ­©</option>
                                    <option value="BICYCLING">è‡ªè»¢è»Š</option>
                                </select>
                            </div>
                            <div>
                                <label for="search_algorithm" class="block text-sm font-medium text-gray-700">æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </label>
                                <select id="search_algorithm" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="fairness">å…¬å¹³æ€§é‡è¦– (ç§»å‹•æ™‚é–“ã®ãƒãƒ©ã¤ãæœ€å°)</option>
                                    <option value="efficiency">åŠ¹ç‡æ€§é‡è¦– (åˆè¨ˆç§»å‹•æ™‚é–“æœ€å°)</option>
                                    <option value="max_relief">æœ€å¤§è² æ‹…è»½æ¸› (æœ€å¤§ç§»å‹•æ™‚é–“æœ€å°)</option>
                                    <option value="quality">å ´æ‰€ã®è³ªã‚’é‡è¦– (è©•ä¾¡ï¼‹å…¬å¹³æ€§)</option>
                                </select>
                            </div>
                            <div>
                                <label for="place_types" class="block text-sm font-medium text-gray-700">é›†åˆå ´æ‰€ã®ç¨®é¡</label>
                                <select id="place_types" multiple class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md h-32">
                                    <option value="cafe" selected>ã‚«ãƒ•ã‚§</option>
                                    <option value="restaurant" selected>ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</option>
                                    <option value="park">å…¬åœ’</option>
                                    <option value="train_station">é§…</option>
                                    <option value="book_store">æ›¸åº—</option>
                                    <option value="shopping_mall">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«</option>
                                </select>
                            </div>
                            <div>
                                <label for="search_radius" class="block text-sm font-medium text-gray-700">æ¤œç´¢åŠå¾„: <span id="radius_value">5000</span>m</label>
                                <input type="range" id="search_radius" min="1000" max="10000" value="5000" step="500" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                             <div>
                                <label for="departure_time" class="block text-sm font-medium text-gray-700">å‡ºç™º/åˆ°ç€ æ™‚åˆ»</label>
                                <input type="datetime-local" id="departure_time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <select id="time_type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="departure">ã“ã®æ™‚åˆ»ã«å‡ºç™º</option>
                                    <option value="arrival">ã“ã®æ™‚åˆ»ã«åˆ°ç€ (å…¬å…±äº¤é€šæ©Ÿé–¢ã®ã¿)</option>
                                </select>
                            </div>
                            <div class="relative flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="avoid_tolls" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="avoid_tolls" class="font-medium text-gray-700">æœ‰æ–™é“è·¯ã‚’é¿ã‘ã‚‹ (è‡ªå‹•è»Š)</label>
                                </div>
                            </div>
                        </div>
                    </details>

                    <button id="search-btn" class="w-full flex items-center justify-center px-6 py-3 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-rocket mr-3"></i>æ¤œç´¢é–‹å§‹
                    </button>
                </div>
            </aside>
            
            <!-- Main Content -->
            <main class="w-full md:w-2/3 lg:w-3/4 p-2 md:p-6" id="main-content">
                <div id="info-panel" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6" role="alert">
                    <p class="font-bold">ã‚ˆã†ã“ãï¼</p>
                    <p>å·¦ã®ãƒ‘ãƒãƒ«ã‹ã‚‰APIã‚­ãƒ¼ã¨ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã€ã€Œæ¤œç´¢é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                     <div id="map-input-info" class="hidden mt-2 p-2 bg-blue-200 rounded">
                        <i class="fas fa-info-circle mr-1"></i> åœ°å›³ä¸Šã®åœ°ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€å‡ºç™ºåœ°ã¾ãŸã¯ç›®çš„åœ°ã«è¨­å®šã§ãã¾ã™ã€‚
                    </div>
                </div>

                <div id="map-container" class="w-full h-96 md:h-[500px] bg-gray-200 rounded-lg shadow-md mb-6 relative">
                     <div id="map" class="w-full h-full rounded-lg"></div>
                     <div id="map-loader" class="hidden absolute inset-0 bg-white/70 flex items-center justify-center flex-col space-y-2 z-20">
                        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
                        <p class="text-lg font-medium">åœ°å›³ã‚’åˆæœŸåŒ–ä¸­...</p>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-container" class="hidden scroll-smooth">
                    <div id="status-container" class="my-4 text-center p-4 border rounded-lg bg-gray-50 hidden">
                        <div id="status-text" class="text-lg font-semibold text-gray-800"></div>
                        <div id="sub-status-text" class="text-sm text-gray-600 mt-1 h-5"></div>
                         <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                            <div id="progress-bar-inner" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="candidates-list" class="space-y-6">
                        <!-- Candidate cards will be shown here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Map Input Modal -->
    <div id="map-input-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">åœ°ç‚¹ã®è¨­å®š</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-4" id="modal-address"></p>
                    <p class="text-sm text-gray-600">ã“ã®åœ°ç‚¹ã‚’ã©ã“ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ</p>
                    <select id="modal-target-select" class="mt-2 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
                        è¨­å®šã™ã‚‹
                    </button>
                    <button id="modal-cancel-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State & DOM Elements ---
        let map, geocoder, directionsService, directionsRenderer;
        let autocompleteObjects = [];
        let participantCount = 0;
        let isMapInputMode = false;
        let clickedLocation = null;
        let currentMarkers = [];
        let currentPolylines = [];

        const DOM = {
            apiKeyMaps: document.getElementById('api_key_maps'),
            participantsContainer: document.getElementById('participants-container'),
            addBtn: document.getElementById('add-participant-btn'),
            removeBtn: document.getElementById('remove-participant-btn'),
            searchBtn: document.getElementById('search-btn'),
            mapContainer: document.getElementById('map'),
            mapLoader: document.getElementById('map-loader'),
            infoPanel: document.getElementById('info-panel'),
            resultsContainer: document.getElementById('results-container'),
            candidatesList: document.getElementById('candidates-list'),
            statusContainer: document.getElementById('status-container'),
            statusText: document.getElementById('status-text'),
            subStatusText: document.getElementById('sub-status-text'),
            progressBar: document.getElementById('progress-bar'),
            progressBarInner: document.getElementById('progress-bar-inner'),
            destinationAddress: document.getElementById('destination_address'),
            toggleSidebarBtn: document.getElementById('toggle-sidebar-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            sidebar: document.getElementById('sidebar'),
            mapInputBtn: document.getElementById('map-input-btn'),
            mapInputInfo: document.getElementById('map-input-info'),
            mapInputModal: document.getElementById('map-input-modal'),
            modalAddress: document.getElementById('modal-address'),
            modalTargetSelect: document.getElementById('modal-target-select'),
            modalConfirmBtn: document.getElementById('modal-confirm-btn'),
            modalCancelBtn: document.getElementById('modal-cancel-btn'),
        };
        
        // --- Initialization ---
        window.onload = () => {
            setupEventListeners();
            addParticipant(); // Add first participant
            addParticipant(); // Add second participant
        };

        function initializeGoogleMaps() {
            const apiKey = DOM.apiKeyMaps.value;
            if (!apiKey) {
                DOM.mapLoader.classList.remove('hidden');
                DOM.mapLoader.innerHTML = `<i class="fas fa-key fa-3x text-red-500"></i><p class="text-lg font-medium mt-2">Maps APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>`;
                return;
            }
            if (window.google?.maps) return;

            DOM.mapLoader.classList.remove('hidden');
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,routes&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                DOM.mapLoader.innerHTML = `<i class="fas fa-exclamation-triangle fa-3x text-red-500"></i><p class="text-lg font-medium mt-2">APIã‚­ãƒ¼ãŒç„¡åŠ¹ã‹ã€èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
                alert("Google Mapsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            };
            window.initMap = initMap; // Make it globally accessible for the callback
            document.head.appendChild(script);
        }

        function initMap() {
            DOM.mapLoader.classList.add('hidden');
            const tokyoStation = { lat: 35.681236, lng: 139.767125 };
            map = new google.maps.Map(DOM.mapContainer, {
                center: tokyoStation,
                zoom: 12,
                mapTypeControl: false,
                streetViewControl: false,
            });
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });
            
            map.addListener('click', handleMapClick);

            document.querySelectorAll('input[data-participant-address]').forEach(input => {
                setupAutocomplete(input);
            });
            setupAutocomplete(DOM.destinationAddress);
        }
        
        // --- UI & Event Listeners ---
        function setupEventListeners() {
            DOM.apiKeyMaps.addEventListener('change', initializeGoogleMaps);
            DOM.addBtn.addEventListener('click', addParticipant);
            DOM.removeBtn.addEventListener('click', removeParticipant);
            DOM.searchBtn.addEventListener('click', startSearch);
            DOM.toggleSidebarBtn.addEventListener('click', () => DOM.sidebar.classList.remove('-translate-x-full'));
            DOM.closeSidebarBtn.addEventListener('click', () => DOM.sidebar.classList.add('-translate-x-full'));
            DOM.mapInputBtn.addEventListener('click', toggleMapInputMode);
            DOM.modalConfirmBtn.addEventListener('click', confirmMapLocation);
            DOM.modalCancelBtn.addEventListener('click', () => DOM.mapInputModal.classList.add('hidden'));
            
            const radiusSlider = document.getElementById('search_radius');
            if (radiusSlider) {
                radiusSlider.addEventListener('input', (e) => {
                    document.getElementById('radius_value').textContent = e.target.value;
                });
            }
        }

        function addParticipant() {
            participantCount++;
            const id = participantCount;
            const participantHTML = `
                <div id="participant-${id}" class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <label class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ³ãƒãƒ¼ ${id}</label>
                    <div class="mt-2 space-y-2">
                        <input type="text" id="name-${id}" value="ãƒ¡ãƒ³ãƒãƒ¼ ${id}" placeholder="åå‰" class="w-full text-sm p-2 border rounded-md">
                        <div class="relative">
                            <input type="text" id="address-${id}" data-participant-address="${id}" placeholder="å‡ºç™ºåœ°ã®ä½æ‰€" class="w-full text-sm p-2 border rounded-md pr-10">
                            <button class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-blue-600" title="GPSã§ç¾åœ¨åœ°ã‚’å–å¾—" onclick="getCurrentLocation(${id})">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                        </div>
                        <select id="mode-${id}" class="w-full text-sm p-2 border rounded-md">
                            <option value="DRIVING">è‡ªå‹•è»Š</option>
                            <option value="TRANSIT">å…¬å…±äº¤é€šæ©Ÿé–¢</option>
                            <option value="WALKING">å¾’æ­©</option>
                            <option value="BICYCLING">è‡ªè»¢è»Š</option>
                        </select>
                    </div>
                </div>`;
            DOM.participantsContainer.insertAdjacentHTML('beforeend', participantHTML);
            
            if (window.google?.maps) {
                setupAutocomplete(document.getElementById(`address-${id}`));
            }
        }
        
        function removeParticipant() {
            if (participantCount > 1) {
                document.getElementById(`participant-${participantCount}`)?.remove();
                participantCount--;
            }
        }
        
        function setupAutocomplete(inputElement) {
            const autocomplete = new google.maps.places.Autocomplete(inputElement, {
                types: ['address'],
                componentRestrictions: { country: 'jp' }
            });
            autocompleteObjects.push(autocomplete);
        }

        window.getCurrentLocation = function(id) {
            if (!navigator.geolocation) {
                alert("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯GPSæ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            navigator.geolocation.getCurrentPosition(position => {
                const latLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                geocoder.geocode({ location: latLng }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        document.getElementById(`address-${id}`).value = results[0].formatted_address;
                    } else { alert("ä½æ‰€ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
                });
            }, () => alert("GPSæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚"));
        }
        
        // --- Map Input Logic ---
        function toggleMapInputMode() {
            isMapInputMode = !isMapInputMode;
            DOM.mapContainer.classList.toggle('crosshair-cursor', isMapInputMode);
            DOM.mapInputInfo.classList.toggle('hidden', !isMapInputMode);
            DOM.mapInputBtn.classList.toggle('bg-blue-100', isMapInputMode);
            DOM.mapInputBtn.classList.toggle('border-blue-500', isMapInputMode);
            DOM.mapInputBtn.innerHTML = isMapInputMode 
                ? '<i class="fas fa-times mr-2"></i>åœ°å›³ã‹ã‚‰ã®æŒ‡å®šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
                : '<i class="fas fa-map-marked-alt mr-2"></i>åœ°å›³ã‹ã‚‰å‡ºç™ºåœ°ã‚’æŒ‡å®š';
        }
        
        function handleMapClick(event) {
            if (!isMapInputMode) return;
            clickedLocation = event.latLng;
            geocoder.geocode({ location: clickedLocation }, (results, status) => {
                if (status === "OK" && results[0]) {
                    DOM.modalAddress.textContent = `åœ°ç‚¹: ${results[0].formatted_address}`;
                    populateModalSelect();
                    DOM.mapInputModal.classList.remove('hidden');
                } else {
                    alert("ã“ã®åœ°ç‚¹ã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
            });
        }
        
        function populateModalSelect() {
            let options = `<option value="destination">ğŸ æœ€çµ‚ç›®çš„åœ°</option>`;
            for (let i = 1; i <= participantCount; i++) {
                const name = document.getElementById(`name-${i}`).value;
                options += `<option value="participant-${i}">ãƒ¡ãƒ³ãƒãƒ¼ ${i} (${name})</option>`;
            }
            DOM.modalTargetSelect.innerHTML = options;
        }
        
        function confirmMapLocation() {
            const target = DOM.modalTargetSelect.value;
            const address = DOM.modalAddress.textContent.replace('åœ°ç‚¹: ', '');
            if (target === 'destination') {
                DOM.destinationAddress.value = address;
            } else {
                const id = target.split('-')[1];
                document.getElementById(`address-${id}`).value = address;
            }
            DOM.mapInputModal.classList.add('hidden');
            toggleMapInputMode(); // Exit map input mode
        }

        // --- Core Search Logic ---
        async function startSearch() {
            DOM.infoPanel.classList.add('hidden');
            DOM.resultsContainer.classList.remove('hidden');
            DOM.candidatesList.innerHTML = '';
            DOM.statusContainer.classList.remove('hidden');
            document.getElementById('main-content').scrollIntoView({ behavior: 'smooth' });

            try {
                const settings = getSettings();
                if (!settings) return;

                updateStatus("STEP 1/4: å‡ºç™ºåœ°ã®åº§æ¨™ã‚’èª¿ã¹ã¦ã„ã¾ã™...", 0);
                const geocodedOrigins = await geocodeParticipants(settings.participants);

                let geocodedDestination = null;
                if (settings.destinationAddress) {
                    geocodedDestination = await geocodeAddress(settings.destinationAddress);
                }
                
                updateStatus("STEP 2/4: å‘¨è¾ºã®é›†åˆå ´æ‰€å€™è£œã‚’æ¢ã—ã¦ã„ã¾ã™...", 25);
                const center = calculateCenter(geocodedOrigins, geocodedDestination);
                const candidatePlaces = await findNearbyPlaces(center, settings.searchRadius, settings.placeTypes);
                if (candidatePlaces.length === 0) {
                     throw new Error("æ¡ä»¶ã«åˆã†æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œç´¢åŠå¾„ã‚„å ´æ‰€ã®ç¨®é¡ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚");
                }

                updateStatus("STEP 3/4: å„å€™è£œåœ°ã¸ã®ç§»å‹•æ™‚é–“ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™...", 50, "æº–å‚™ä¸­...");
                const evaluatedCandidates = await evaluateCandidates(candidatePlaces, geocodedOrigins, geocodedDestination, settings);
                if (evaluatedCandidates.length === 0) {
                     throw new Error("è©•ä¾¡å¯èƒ½ãªé›†åˆå ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç§»å‹•ã§ããªã„å ´æ‰€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                }
                
                updateStatus("STEP 4/4: çµæœã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™...", 90);
                const sortedCandidates = sortCandidates(evaluatedCandidates, settings.searchAlgorithm);
                const topCandidates = sortedCandidates.slice(0, 5); // Show top 5
                
                updateStatus("æ¤œç´¢å®Œäº†ï¼", 100);
                displayResults(topCandidates, geocodedOrigins, geocodedDestination);
                setTimeout(() => DOM.statusContainer.classList.add('hidden'), 4000);

            } catch (error) {
                console.error("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", error);
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, -1);
            }
        }
        
        function getSettings() {
            const participants = [];
            for (let i = 1; i <= participantCount; i++) {
                const addressInput = document.getElementById(`address-${i}`);
                if (!addressInput.value.trim()) { alert(`ãƒ¡ãƒ³ãƒãƒ¼ ${i} ã®ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`); return null; }
                participants.push({
                    id: i,
                    name: document.getElementById(`name-${i}`).value,
                    address: addressInput.value,
                    mode: document.getElementById(`mode-${i}`).value
                });
            }
            if (participants.length < 2) { alert("ãƒ¡ãƒ³ãƒãƒ¼ã¯2äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚"); return null; }
            
            const drivingOptions = {};
            const transitOptions = {};
            const departureTime = document.getElementById('departure_time').value;
            if (departureTime) {
                const time = new Date(departureTime);
                if(document.getElementById('time_type').value === 'departure') {
                    drivingOptions.departureTime = time;
                    transitOptions.departureTime = time;
                } else {
                    transitOptions.arrivalTime = time; // Arrival time is only for transit
                }
            }

            return {
                participants,
                destinationAddress: document.getElementById('destination_address').value.trim(),
                commonMode: document.getElementById('common_mode').value,
                searchAlgorithm: document.getElementById('search_algorithm').value,
                placeTypes: Array.from(document.getElementById('place_types').selectedOptions).map(opt => opt.value),
                searchRadius: parseInt(document.getElementById('search_radius').value, 10),
                avoidTolls: document.getElementById('avoid_tolls').checked,
                drivingOptions,
                transitOptions
            };
        }

        async function evaluateCandidates(candidates, origins, destination, settings) {
            let evaluated = [];
            for (let i = 0; i < candidates.length; i++) {
                const place = candidates[i];
                updateStatus("STEP 3/4: å„å€™è£œåœ°ã¸ã®ç§»å‹•æ™‚é–“ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™...", 50 + (40 * (i/candidates.length)), `è©•ä¾¡ä¸­ [${i+1}/${candidates.length}]: ${place.name}`);

                let t2_duration_sec = 0;
                if (destination) {
                    const dirToDest = await getDirections(place.geometry.location, destination.geometry.location, settings.commonMode, settings);
                    if (!dirToDest) continue; // Skip if candidate is unreachable from destination
                    t2_duration_sec = dirToDest.routes[0].legs[0].duration.value;
                }

                const durations = [];
                let isReachableByAll = true;
                for (const origin of origins) {
                    const dirToPlace = await getDirections(origin.location, place.geometry.location, origin.mode, settings);
                    if (dirToPlace) {
                        const t1_duration = dirToPlace.routes[0].legs[0].duration;
                        const total_sec = t1_duration.value + t2_duration_sec;
                        durations.push({ 
                            origin_name: origin.name, 
                            total_sec, 
                            total_text: secondsToText(total_sec),
                        });
                    } else {
                        isReachableByAll = false;
                        break;
                    }
                }
                
                if (isReachableByAll) {
                    const times = durations.map(d => d.total_sec);
                    evaluated.push({
                        place,
                        durations,
                        stats: {
                            std_dev: calculateStdDev(times),
                            total: times.reduce((a, b) => a + b, 0),
                            max: Math.max(...times),
                            rating: place.rating || 0
                        }
                    });
                }
            }
            return evaluated;
        }

        // --- Utility & Helper Functions (Geocoding, API calls, etc.) ---
        
        async function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address }, (results, status) => {
                    if (status === 'OK') resolve(results[0]);
                    else reject(new Error(`ã€Œ${address}ã€ã®åº§æ¨™å–å¾—ã«å¤±æ•—: ${status}`));
                });
            });
        }
        
        async function geocodeParticipants(participants) {
            const geocoded = [];
            for (const p of participants) {
                const result = await geocodeAddress(p.address);
                geocoded.push({ ...p, location: result.geometry.location, formatted_address: result.formatted_address });
            }
            return geocoded;
        }

        function calculateCenter(origins, destination) {
            const points = origins.map(o => o.location);
            if (destination) points.push(destination.geometry.location);
            const lat = points.reduce((sum, p) => sum + p.lat(), 0) / points.length;
            const lng = points.reduce((sum, p) => sum + p.lng(), 0) / points.length;
            return { lat, lng };
        }

        async function findNearbyPlaces(center, radius, types) {
             return new Promise((resolve) => {
                const service = new google.maps.places.PlacesService(map);
                const request = { location: center, radius, types, language: 'ja' };
                service.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK || status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                        resolve(results || []);
                    } else {
                         console.warn("Nearby search failed:", status);
                         resolve([]);
                    }
                });
            });
        }
        
        async function getDirections(origin, destination, mode, settings) {
            const request = {
                origin,
                destination,
                travelMode: google.maps.TravelMode[mode],
                avoidTolls: settings.avoidTolls,
            };
            if (mode === 'DRIVING') {
                Object.assign(request, settings.drivingOptions);
            } else if (mode === 'TRANSIT') {
                Object.assign(request, settings.transitOptions);
            }

            return new Promise(resolve => {
                directionsService.route(request, (result, status) => {
                    if (status === 'OK') resolve(result);
                    else {
                        // console.warn(`Directions failed: ${status} for mode ${mode}`);
                        resolve(null);
                    }
                });
            });
        }
        
        // --- Sorting and Display ---
        
        function sortCandidates(candidates, algorithm) {
            return candidates.sort((a, b) => {
                switch(algorithm) {
                    case 'efficiency': return a.stats.total - b.stats.total;
                    case 'max_relief': return a.stats.max - b.stats.max;
                    case 'quality':
                        const scoreA = (a.stats.std_dev / 300) - (a.stats.rating * 2); 
                        const scoreB = (b.stats.std_dev / 300) - (b.stats.rating * 2);
                        return scoreA - scoreB;
                    default: return a.stats.std_dev - b.stats.std_dev;
                }
            });
        }

        function displayResults(candidates, origins, destination) {
            DOM.candidatesList.innerHTML = '';
            if (candidates.length === 0) {
                DOM.candidatesList.innerHTML = `<p class="text-center text-gray-500">æ¡ä»¶ã«åˆã†å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
                return;
            }
            
            candidates.forEach((candidate, index) => {
                const card = createCandidateCard(candidate, index, origins, destination);
                DOM.candidatesList.appendChild(card);
            });
            
            document.getElementById('candidate-0')?.dispatchEvent(new Event('click'));
        }

        function createCandidateCard(candidate, index, origins, destination) {
            const { place, durations, stats } = candidate;
            const card = document.createElement('div');
            card.id = `candidate-${index}`;
            card.className = 'border rounded-lg p-4 cursor-pointer hover:shadow-lg hover:border-blue-500 transition-all bg-white';
            const ratingHTML = place.rating ? `<span class="text-yellow-500">${'â˜…'.repeat(Math.round(place.rating))}</span> ${place.rating} (${place.user_ratings_total || 'N/A'})` : 'è©•ä¾¡ãªã—';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xl font-bold text-blue-700">${index + 1}. ${place.name}</h3>
                        <p class="text-sm text-gray-600">${place.vicinity}</p>
                        <p class="text-sm mt-1">${ratingHTML}</p>
                    </div>
                    <div class="text-right text-sm flex-shrink-0 ml-4">
                        <p>å…¬å¹³æ€§ (ã°ã‚‰ã¤ã): <strong>${secondsToText(stats.std_dev)}</strong></p>
                        <p>åˆè¨ˆæ™‚é–“: <strong>${secondsToText(stats.total, true)}</strong></p>
                        <p>æœ€å¤§æ™‚é–“: <strong>${secondsToText(stats.max)}</strong></p>
                    </div>
                </div>
                <div class="details mt-2 pt-2 border-t hidden">
                    <h4 class="font-semibold">å„ãƒ¡ãƒ³ãƒãƒ¼ã®ç§»å‹•æ™‚é–“:</h4>
                    <ul class="list-disc list-inside text-sm mt-1">${durations.map(d => `<li><strong>${d.origin_name}:</strong> ${d.total_text}</li>`).join('')}</ul>
                </div>`;
            
            card.addEventListener('click', () => {
                document.querySelectorAll('.details').forEach(d => d.classList.add('hidden'));
                document.querySelectorAll('.border-blue-500').forEach(el => el.classList.remove('border-blue-500', 'bg-blue-50'));
                card.querySelector('.details').classList.remove('hidden');
                card.classList.add('border-blue-500', 'bg-blue-50');
                updateMapForCandidate(candidate, origins, destination);
            });

            return card;
        }
        
        function updateMapForCandidate(candidate, origins, destination) {
            currentMarkers.forEach(m => m.setMap(null));
            currentPolylines.forEach(p => p.setMap(null));
            currentMarkers = [];
            currentPolylines = [];
            directionsRenderer.setDirections({routes: []}); // Clear previous routes

            const bounds = new google.maps.LatLngBounds();
            const colors = ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#9C27B0', '#FF6D00'];

            origins.forEach((origin, i) => {
                const marker = new google.maps.Marker({
                    position: origin.location,
                    map,
                    label: { text: `${i + 1}`, color: "white" },
                    title: `å‡ºç™ºåœ°: ${origin.name}`
                });
                currentMarkers.push(marker);
                bounds.extend(origin.location);
            });

            if (destination) {
                currentMarkers.push(new google.maps.Marker({
                    position: destination.geometry.location,
                    map,
                    icon: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    title: `æœ€çµ‚ç›®çš„åœ°: ${destination.formatted_address}`
                }));
                 bounds.extend(destination.geometry.location);
            }

            currentMarkers.push(new google.maps.Marker({
                position: candidate.place.geometry.location,
                map,
                icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                title: `é›†åˆå ´æ‰€: ${candidate.place.name}`,
                animation: google.maps.Animation.DROP
            }));
            bounds.extend(candidate.place.geometry.location);
            
            map.fitBounds(bounds);
        }

        function updateStatus(message, progress, subMessage = '&nbsp;') {
            DOM.statusText.textContent = message;
            DOM.subStatusText.innerHTML = subMessage;
            DOM.progressBarInner.classList.remove('bg-red-500');
            if (progress >= 0) {
                 DOM.progressBarInner.style.width = `${progress}%`;
                 DOM.statusText.classList.remove('text-red-500');
            } else {
                 DOM.progressBarInner.style.width = `100%`;
                 DOM.progressBarInner.classList.add('bg-red-500');
                 DOM.statusText.classList.add('text-red-500');
            }
        }
        
        function secondsToText(seconds, isTotal = false) {
            seconds = Math.round(seconds);
            const days = Math.floor(seconds / 86400);
            const h = Math.floor((seconds % 86400) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            let text = "";
            if (days > 0 && isTotal) text += `${days}æ—¥ã¨`;
            if (h > 0) text += `${h}æ™‚é–“`;
            if (m > 0 || text === "") text += `${m}åˆ†`;
            return text.trim() || "0åˆ†";
        }

        function calculateStdDev(arr) {
            const n = arr.length;
            if (n < 2) return 0;
            const mean = arr.reduce((a, b) => a + b, 0) / n;
            return Math.sqrt(arr.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n);
        }

    </script>
</body>
</html>
